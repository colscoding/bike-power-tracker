(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const C=e=>{const t=Math.floor(e/1e3),n=Math.floor(t/3600),a=Math.floor(t%3600/60),o=t%60;return`${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},D=e=>{const t=document.getElementById("startStop"),n=document.getElementById("time"),a=document.getElementById("metricsTable");setInterval(()=>{let o="00:00:00";if(e.startTime&&e.running){const r=Date.now()-e.startTime;o=C(r)}else if(e.startTime&&e.endTime){const r=e.endTime-e.startTime;o=C(r)}n.textContent!==o&&(n.textContent=o);const s=e.running?"â¹ï¸":"â–¶ï¸";t.textContent!==s&&(t.textContent=s),e.running?a.classList.remove("paused"):a.classList.add("paused")},100),t.addEventListener("click",()=>{if(e.running)e.running=!1,e.endTime=Date.now(),t.textContent="â–¶ï¸";else{if(e.endTime){const o=Date.now()-e.endTime;e.startTime+=o,e.endTime=null}else e.startTime=Date.now();e.running=!0,t.textContent="â¹ï¸"}})},E=(e,t)=>{const n=[];let a=0;for(const o of t){for(;a<e.length&&e[a].timestamp<o;)a++;const s=a-1;let r;const c=a>=e.length;if(s<0)r=e?.[a];else if(c)r=e?.[s];else{const i=e?.[s]?.timestamp??0,m=e?.[a]?.timestamp??0;r=o-i<=m-o?e?.[s]:e?.[a]}r?.timestamp&&Math.abs(r.timestamp-o)<1e3?n.push(r.value):n.push(null)}return n},L=e=>{const t=[e.heartrate,e.cadence,e.power];if(!t.some(d=>d.length>0))return[];const a=t.map(d=>d.length>0?d[0].timestamp:1/0),o=Math.min(...a),s=Math.max(...t.map(d=>d.length>0?d[d.length-1].timestamp:-1/0)),r=1e3,c=[];let i=o;for(;i<=s;)c.push(i),i+=r;const m=E(e.heartrate,c),u=E(e.cadence,c),l=E(e.power,c),p=[];for(let d=0;d<c.length;d++){const f={timestamp:c[d],heartrate:m[d]??null,cadence:u[d]??null,power:l[d]??null};p.push(f)}return p},I=e=>{const t=L(e);if(!t||t.length===0)return"";const n="timestamp,power,cadence,heartrate",a=t.map(o=>{const s=new Date(o.timestamp).toISOString(),r=o.power!==null?Math.round(o.power):"",c=o.cadence!==null?Math.round(o.cadence):"",i=o.heartrate!==null?Math.round(o.heartrate):"";return`${s},${r},${c},${i}`});return[n,...a].join(`
`)};class P{constructor(){this.heartrate=[],this.power=[],this.cadence=[]}addHeartrate({timestamp:t,value:n}){if(n<=0||n>=300)throw new Error("Heartrate must be between 1 and 299");this.heartrate.push({timestamp:t,value:n})}addPower({timestamp:t,value:n}){if(n<=0||n>=3e3)throw new Error("Power must be between 1 and 2999");this.power.push({timestamp:t,value:n})}addCadence({timestamp:t,value:n}){if(n<=0||n>=300)throw new Error("Cadence must be between 1 and 299");this.cadence.push({timestamp:t,value:n})}add(t,n){if(t==="heartrate")this.addHeartrate(n);else if(t==="power")this.addPower(n);else if(t==="cadence")this.addCadence(n);else throw new Error(`Unknown measurement type: ${t}`)}}const $=e=>e!==null?`<HeartRateBpm><Value>${Math.round(e)}</Value></HeartRateBpm>`:"",U=e=>e!==null?`<Cadence>${Math.round(e)}</Cadence>`:"",R=e=>e===null?"":`<Extensions>
              <TPX xmlns="http://www.garmin.com/xmlschemas/ActivityExtension/v2">
                <Watts>${Math.round(e)}</Watts>
              </TPX>
            </Extensions>`,M=e=>{const t=new Date(e.timestamp).toISOString(),a=Object.entries({heartrate:$,cadence:U,power:R}).map(([s,r])=>{const c=e[s];return c!==null?r(c):""}).filter(s=>s!=="");return`
<Trackpoint>
    <Time>${t}</Time>
    ${a.join(`
`)}
</Trackpoint>
    `.trim()},_=e=>{const t=L(e);if(!t||t.length===0)return"";const n=t[0].timestamp,a=t[t.length-1].timestamp,o=Math.round((a-n)/1e3),s=new Date(n).toISOString();return`<?xml version="1.0" encoding="UTF-8"?>
    <TrainingCenterDatabase xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2">
        <Activities>
            <Activity Sport="Biking">
                <Id>${s}</Id>
                <Lap StartTime="${s}">
                    <TotalTimeSeconds>${o}</TotalTimeSeconds>
                    <Calories>0</Calories>
                    <Intensity>Active</Intensity>
                    <TriggerMethod>Manual</TriggerMethod>
                    <Track>
${t.map(M).join(`
`)}
                    </Track>
                </Lap>
            </Activity>
        </Activities>
    </TrainingCenterDatabase>`},j=({measurementsState:e,timeState:t})=>{document.getElementById("discardButton").addEventListener("click",()=>{confirm("Are you sure you want to discard this workout?")&&(t.running=!1,t.startTime=null,t.endTime=null,e.power=[],e.heartrate=[],e.cadence=[])})},O=e=>{document.getElementById("exportData").addEventListener("click",()=>{try{const n=new Date,a=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}-${String(n.getHours()).padStart(2,"0")}-${String(n.getMinutes()).padStart(2,"0")}-${String(n.getSeconds()).padStart(2,"0")}`,o={power:e.power,heartrate:e.heartrate,cadence:e.cadence},s=JSON.stringify(o,null,2),r=new Blob([s],{type:"application/json"}),c=URL.createObjectURL(r),i=document.createElement("a");i.href=c,i.download=`bike-measurements-${a}.json`,i.click(),URL.revokeObjectURL(c);const m=_(e),u=new Blob([m],{type:"application/xml"}),l=URL.createObjectURL(u),p=document.createElement("a");p.href=l,p.download=`bike-workout-${a}.tcx`,p.click(),URL.revokeObjectURL(l);const d=I(e),f=new Blob([d],{type:"text/csv"}),h=URL.createObjectURL(f),g=document.createElement("a");g.href=h,g.download=`bike-workout-${a}.csv`,g.click(),URL.revokeObjectURL(h)}catch(n){console.error("Error exporting data:",n)}})},A=document.getElementById("connectPower"),N=document.getElementById("connectHeartrate"),W=document.getElementById("connectCadence"),H=document.getElementById("power"),q=document.getElementById("heartrate"),F=document.getElementById("cadence"),v={power:{display:H,connect:A},heartrate:{display:q,connect:N},cadence:{display:F,connect:W}},V=({connectionsState:e,measurementsState:t})=>{const n=o=>{const s=v?.[o]?.display;if(!s||!e?.[o])return;const r="--";if(!e?.[o]?.isConnected){s.textContent=r;return}const c=t[o];if(!Array.isArray(c)||c.length===0){s.textContent=r;return}const i=c[c.length-1];if(!i||typeof i.value!="number"||typeof i.timestamp!="number"){s.textContent=r;return}if(Date.now()-i.timestamp>5e3){s.textContent=r;return}s.textContent=i.value},a=["power","heartrate","cadence"];setInterval(()=>{a.forEach(n)},100)},X=async()=>{const e=[];let t=null,n=null;const a=await navigator.bluetooth.requestDevice({filters:[{services:["cycling_speed_and_cadence"]}],optionalServices:["cycling_speed_and_cadence"]}),r=await(await(await a.gatt.connect()).getPrimaryService("cycling_speed_and_cadence")).getCharacteristic("csc_measurement");return await r.startNotifications(),r.addEventListener("characteristicvaluechanged",c=>{const i=c.target.value,m=i.getUint8(0);if(m&2){let u=1;m&1&&(u=5);const l=i.getUint16(u,!0),p=i.getUint16(u+2,!0);if(t!==null&&n!==null){let d=l-t,f=p-n;if(d<0&&(d+=65536),f<0&&(f+=65536),f>0){const h=f/1024,g=Math.round(d/h*60);if(g>0&&g<300){const k={timestamp:Date.now(),value:g};e.forEach(S=>S(k))}}}t=l,n=p}}),{disconnect:()=>{r.stopNotifications(),a.gatt.disconnect()},addListener:c=>{e.push(c)}}},J=async()=>X(),K=async()=>{const e=[],t=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]}],optionalServices:["heart_rate"]}),o=await(await(await t.gatt.connect()).getPrimaryService("heart_rate")).getCharacteristic("heart_rate_measurement");return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",s=>{const c=s.target.value.getUint8(1),i={timestamp:Date.now(),value:c};e.forEach(m=>m(i))}),{disconnect:()=>{o.stopNotifications(),t.gatt.disconnect()},addListener:s=>{e.push(s)}}},Y=async()=>K(),z=async()=>{const e=[],t=await navigator.bluetooth.requestDevice({filters:[{services:["cycling_power"]}],optionalServices:["cycling_power"]}),o=await(await(await t.gatt.connect()).getPrimaryService("cycling_power")).getCharacteristic("cycling_power_measurement");return await o.startNotifications(),o.addEventListener("characteristicvaluechanged",s=>{const c=s.target.value.getUint16(2,!0),i={timestamp:Date.now(),value:c};e.forEach(m=>m(i))}),{disconnect:()=>{o.stopNotifications(),t.gatt.disconnect()},addListener:s=>{e.push(s)}}},G=async()=>z(),Q=({connectionsState:e,measurementsState:t})=>{const n=["power","heartrate","cadence"],a={power:"âš¡",heartrate:"â¤ï¸",cadence:"ðŸš´"},o=r=>{if(typeof e[r].disconnect=="function"){e[r].disconnect(),e[r].disconnect=null,e[r].isConnected=!1;const c=v[r]?.connect;c?.textContent&&(c.textContent=`${a[r]} Connect ${r.charAt(0).toUpperCase()+r.slice(1)}`);const i=v?.[r]?.display;i?.textContent&&(i.textContent="--")}},s=async r=>{const c={power:G,heartrate:Y,cadence:J};try{const{disconnect:i,addListener:m}=await c[r]();e[r].disconnect=i,e[r].isConnected=!0,m(l=>{t.add(r,l)});const u=v[r]?.connect;u?.textContent&&(u.textContent=`${a[r]} Disconnect ${r.charAt(0).toUpperCase()+r.slice(1)}`)}catch(i){console.error(`Error connecting ${r}:`,i)}};n.forEach(r=>{const c=v[r]?.connect;c&&c.addEventListener("click",async()=>{e[r].isConnected?o(r):s(r)})})},Z=()=>({measurementsState:new P,connectionsState:{power:{isConnected:!1,disconnect:null},heartrate:{isConnected:!1,disconnect:null},cadence:{isConnected:!1,disconnect:null}},timeState:{running:!1,startTime:null,endTime:null}}),ee=()=>{let e=null;const t=async()=>{try{"wakeLock"in navigator&&(e=await navigator.wakeLock.request("screen"),console.log("Screen wake lock activated"),e.addEventListener("release",()=>{console.log("Screen wake lock released")}))}catch(n){console.error("Wake lock request failed:",n)}};document.visibilityState==="visible"&&t(),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&t()})},te="modulepreload",ne=function(e){return"/bike-power-tracker/"+e},x={},oe=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let m=function(u){return Promise.all(u.map(l=>Promise.resolve(l).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};var r=m;document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),i=c?.nonce||c?.getAttribute("nonce");o=m(n.map(u=>{if(u=ne(u),u in x)return;x[u]=!0;const l=u.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${p}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":te,l||(d.as="script"),d.crossOrigin="",d.href=u,i&&d.setAttribute("nonce",i),document.head.appendChild(d),l)return new Promise((f,h)=>{d.addEventListener("load",f),d.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${u}`)))})}))}function s(c){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=c,window.dispatchEvent(i),!i.defaultPrevented)throw c}return o.then(c=>{for(const i of c||[])i.status==="rejected"&&s(i.reason);return t().catch(s)})};function re(e={}){const{immediate:t=!1,onNeedRefresh:n,onOfflineReady:a,onRegistered:o,onRegisteredSW:s,onRegisterError:r}=e;let c,i;const m=async(l=!0)=>{await i};async function u(){if("serviceWorker"in navigator){if(c=await oe(async()=>{const{Workbox:l}=await import("./workbox-window.prod.es5-CwtvwXb3.js");return{Workbox:l}},[]).then(({Workbox:l})=>new l("/bike-power-tracker/sw.js",{scope:"/bike-power-tracker/",type:"classic"})).catch(l=>{r?.(l)}),!c)return;c.addEventListener("activated",l=>{(l.isUpdate||l.isExternal)&&window.location.reload()}),c.addEventListener("installed",l=>{l.isUpdate||a?.()}),c.register({immediate:t}).then(l=>{s?s("/bike-power-tracker/sw.js",l):o?.(l)}).catch(l=>{r?.(l)})}}return i=u(),m}const se=()=>{const e=re({onNeedRefresh(){ce(e)},onOfflineReady(){console.log("App ready to work offline")},onRegisteredSW(t,n){console.log("Service Worker registered successfully:",t),n&&setInterval(()=>{n.update()},36e5)},onRegisterError(t){console.log("Service Worker registration failed:",t)}})},ce=e=>{const t=document.getElementById("updateNotification");t&&(t.style.display="block",document.getElementById("updateButton").addEventListener("click",()=>{e(!0)},{once:!0}),document.getElementById("dismissUpdate").addEventListener("click",()=>{t.style.display="none"},{once:!0}))};let w=null;const ie=()=>{window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),w=e,ae()}),window.addEventListener("appinstalled",()=>{console.log("PWA was installed successfully"),w=null,T()})},ae=()=>{const e=document.getElementById("installPrompt");e&&(e.style.display="block",document.getElementById("installButton").addEventListener("click",async()=>{if(!w)return;w.prompt();const{outcome:a}=await w.userChoice;console.log(`User response to the install prompt: ${a}`),w=null,T()}),document.getElementById("dismissInstall").addEventListener("click",()=>{T()}))},T=()=>{const e=document.getElementById("installPrompt");e&&(e.style.display="none")};function le({measurementsState:e,connectionsState:t}){typeof window<"u"&&(window.bike=e,window.connectionsState=t)}const{measurementsState:y,connectionsState:b,timeState:B}=Z();le({measurementsState:y,connectionsState:b});D(B);V({connectionsState:b,measurementsState:y});Q({connectionsState:b,measurementsState:y});j({measurementsState:y,timeState:B});O(y);ee();se();ie();
//# sourceMappingURL=index-DMIrMto5.js.map
